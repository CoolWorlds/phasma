#!/Applications/Develop/Mathematica.app/Contents/MacOS/MathematicaScript-script

thisfolder=NotebookDirectory[];
kicfolder=Last[StringSplit[thisfolder,"/"]];
kic=First[StringSplit[kicfolder,"."]];
planetnumber=Last[StringSplit[kicfolder,"."]];
ephemeris=Import[StringReplace[thisfolder,StringJoin["AUTO/",kicfolder,"/"]->"ephemeris.dat"],"CSV"];
positions=Flatten[Position[ephemeris[[All,2]],ToExpression[kic]]];
temp=Table[{positions[[i]],Last[StringSplit[Extract[Extract[ephemeris,positions[[i]]],3],"."]]},{i,1,Length[positions]}];
planetposition=First[Extract[temp,First[FirstPosition[temp[[All,2]],planetnumber]]]];
toff=54833;
Pp=Extract[Extract[ephemeris,planetposition],4];
τ0=Extract[Extract[ephemeris,planetposition],5]+toff;
T14=N[Extract[Extract[ephemeris,planetposition],6]/24];
nmax=Length[Import[StringJoin[thisfolder,"RawsLC/files.txt"],"Table"]];
pdc=1;
nfile=0;Label[nloop];nfile=nfile+1;filelist=Import[StringJoin[thisfolder,"RawsLC/files.txt"],"Table"];inputfile=First[Extract[filelist,nfile]];raw=Join[Import[StringJoin[thisfolder,"RawsLC/",inputfile],"Table"]];"Remove anomalous rows";j=0;Label[jloop1];j=j+1;Subscript[α, j]=First[Dimensions[Extract[raw,j]]];If[j<Length[raw],Goto[jloop1]];dim=Median[Table[Subscript[α, jj],{jj,1,j}]];raw=Select[raw,Length[#]==dim&];"Remove poor SAP flags";raw=Select[raw,#[[6]]==0&];"Select PDC or PA data aapproriately";If[pdc==0,text="PA",text="PDC"];If[pdc==1,err=Table[{Extract[Extract[raw,i],1]+toff,Extract[Extract[raw,i],4],Extract[Extract[raw,i],5]},{i,1,Length[raw]}],err=Table[{Extract[Extract[raw,i],1]+toff,Extract[Extract[raw,i],2],Extract[Extract[raw,i],3]},{i,1,Length[raw]}]];"Remove strings";err=Select[err,ValueQ[#[[3]]]==True&];window=Pp;tstart=Min[err[[All,1]]]+0.5window;tend=Max[err[[All,1]]];cadence=0.02043361111111111;m=0;j=0;Label[jloop2];j=j+1;temp=Select[err,tstart+(j-1)cadence<=#[[1]]<tstart+j cadence+window&];If[Length[temp]>0,m=m+1];If[Length[temp]>0,Subscript[β, m]={tstart+(j-0.5)cadence,Median[temp[[All,2]]]}];If[tstart+j cadence+window<tend,Goto[jloop2]];meddy=Table[Subscript[β, mm],{mm,1,m}];tp=Min[meddy[[All,1]]];tq=Max[meddy[[All,1]]];errsel=Select[err,tp<=#[[1]]<=tq&];meddyfn=Interpolation[DeleteDuplicates[meddy]];Subscript[detrend, nfile]=Table[{Extract[Extract[errsel,i],1],Extract[Extract[errsel,i],2]/meddyfn[Extract[Extract[errsel,i],1]],Extract[Extract[errsel,i],3]/meddyfn[Extract[Extract[errsel,i],1]]},{i,1,Length[errsel]}];If[nfile<nmax,Goto[nloop]];
lightcurve=Flatten[Table[Subscript[detrend, nn],{nn,1,nmax}],1];
fold=Table[{Extract[Extract[lightcurve,i],1]-Pp Round[(Extract[Extract[lightcurve,i],1]-τ0)/Pp]-τ0,Extract[Extract[lightcurve,i],2],Extract[Extract[lightcurve,i],3]},{i,1,Length[lightcurve]}];
foldsort=Sort[fold];
pointsin=Length[Select[foldsort,-0.55T14<#[[1]]<0.55T14&]];
binsize=Max[Round[pointsin/100],10];
movmed=MovingMedian[foldsort[[All,{1,2}]],binsize];
ListPlot[{fold[[All,{1,2}]],movmed},PlotStyle->{Gray,Red},PlotRange->{{-0.5Pp,0.5Pp},{0.98,1.01}},GridLines->{{-0.55T14,0.55T14},{}}];
inter=Interpolation[DeleteDuplicates[movmed]];
ta=Min[movmed[[All,1]]];tb=Max[movmed[[All,1]]];
foldsel=Select[fold,ta<=#[[1]]<=tb&];
res=Table[(Extract[Extract[foldsel,i],2]-inter[Extract[Extract[foldsel,i],1]])/Extract[Extract[foldsel,i],3],{i,1,Length[foldsel]}];
fac=1.4286MedianDeviation[res];
sig=N[Sqrt[2]InverseErfc[1/Length[res]]];
j=0;m=0;Label[jloop];j=j+1;If[Abs[(Extract[Extract[fold,j],2]-inter[Extract[Extract[fold,j],1]])/Extract[Extract[fold,j],3]]<fac*sig,m=m+1];If[Abs[(Extract[Extract[fold,j],2]-inter[Extract[Extract[fold,j],1]])/Extract[Extract[fold,j],3]]<fac*sig,Subscript[γ, m]=Extract[lightcurve,j]];If[j<Length[lightcurve],Goto[jloop]];
lightcurve2=Table[Subscript[γ, mm],{mm,1,m}];
fold2=Table[{Extract[Extract[lightcurve2,i],1]-Pp Round[(Extract[Extract[lightcurve2,i],1]-τ0)/Pp]-τ0,Extract[Extract[lightcurve2,i],2],Extract[Extract[lightcurve2,i],3]},{i,1,Length[lightcurve2]}];
foldsort2=Sort[fold2];
pointsin2=Length[Select[foldsort2,-0.55T14<#[[1]]<0.55T14&]];
binsize2=Max[Round[pointsin2/100],10];
movmed2=MovingMedian[foldsort2[[All,{1,2}]],binsize2];
inter2=Interpolation[DeleteDuplicates[movmed2]];
ta=Min[movmed2[[All,1]]];tb=Max[movmed2[[All,1]]];
foldsel2=Select[fold2,ta<=#[[1]]<=tb&];
res2=Table[(Extract[Extract[foldsel2,i],2]-inter2[Extract[Extract[foldsel2,i],1]])/Extract[Extract[foldsel2,i],3],{i,1,Length[foldsel2]}];
fac2=1.4286MedianDeviation[res2];
sig2=N[Sqrt[2]InverseErfc[1/Length[res2]]];
j=0;m=0;Label[jloop];j=j+1;If[Abs[(Extract[Extract[fold2,j],2]-inter2[Extract[Extract[fold2,j],1]])/Extract[Extract[fold2,j],3]]<fac2*sig2,m=m+1];If[Abs[(Extract[Extract[fold2,j],2]-inter2[Extract[Extract[fold2,j],1]])/Extract[Extract[fold2,j],3]]<fac2*sig2,Subscript[γ2, m]=Extract[lightcurve2,j]];If[j<Length[lightcurve2],Goto[jloop]];
lightcurve3=Table[Subscript[γ2, mm],{mm,1,m}];
fold3=Table[{Extract[Extract[lightcurve3,i],1]-Pp Round[(Extract[Extract[lightcurve3,i],1]-τ0)/Pp]-τ0,Extract[Extract[lightcurve3,i],2],Extract[Extract[lightcurve3,i],3]},{i,1,Length[lightcurve3]}];
foldsort3=Sort[fold3];
foldsort3out=Table[{Extract[Extract[foldsort3,i],1]/Pp,Extract[Extract[foldsort3,i],2],Extract[Extract[foldsort3,i],3]},{i,1,Length[foldsort3]}];
pointsin3=Length[Select[foldsort3,-0.55T14<#[[1]]<0.55T14&]];
binsize3=Max[Round[pointsin3/100],10];
movmed3=MovingMedian[foldsort3[[All,{1,2}]],binsize3];
foldx=Sort[fold3];Sort[Select[fold3,!-0.55T14<#[[1]]<0.55T14&]];
foldx=Table[{Extract[Extract[foldx,i],1]/Pp,Extract[Extract[foldx,i],2],Extract[Extract[foldx,i],3]},{i,1,Length[foldx]}];
bins=Table[x,{x,-0.5,0.5,0.002}];
t=0;z=0;Label[tloop];t=t+1;tab=Select[foldx,Extract[bins,t]<#[[1]]<Extract[bins,t+1]&];weights=Table[Extract[Extract[tab,i],3]^(-2),{i,1,Length[tab]}];If[Length[tab]>0,z=z+1];If[Length[tab]>0,V1=Sum[Extract[weights,i],{i,1,Length[tab]}]];If[Length[tab]>0,V2=Sum[Extract[weights,i]^2,{i,1,Length[tab]}]];If[Length[tab]>0,μstar=Sum[Extract[Extract[tab,i],2]Extract[weights,i],{i,1,Length[tab]}]/Sum[Extract[weights,i],{i,1,Length[tab]}]];If[Length[tab]>0,s2=Sum[Extract[weights,i](Extract[Extract[tab,i],2]-μstar)^2,{i,1,Length[tab]}]/(V1-(V2/V1))];If[Length[tab]>0,Subscript[ζ, z]={(Extract[bins,t]+Extract[bins,t+1])*0.5,μstar,Sqrt[s2]/Sqrt[Length[tab]-1],Sum[weights[[i]],{i,1,Length[weights]}]^(-1/2)}];If[Length[tab]>0,Subscript[ζlen, z]=Length[tab]];If[t<Length[bins]-1,Goto[tloop]];
foldxbin=Table[Subscript[ζ, zz],{zz,1,z}];
foldzbin=Table[{Extract[Extract[foldxbin,i],1],(Extract[Extract[foldxbin,i],2]-1)*10^6,Extract[Extract[foldxbin,i],3]*10^6,Extract[Extract[foldxbin,i],4]*10^6},{i,1,Length[foldxbin]}];
<<ErrorBarPlots`
plotty=Show[ListPlot[foldx[[All,{1,2}]],PlotStyle->Directive[Gray,Opacity[0.4]],PlotRange->{{-0.5,0.5},Automatic},Frame->True,ImageSize->{600,400},Axes->None,BaseStyle->{FontFamily->"Helvetica",FontSize->20}],ErrorListPlot[foldxbin[[All,{1,2,3}]],PlotStyle->Pink]];
Export[StringJoin[thisfolder,"lightcurve.dat"],lightcurve,"Table"];
Export[StringJoin[thisfolder,"fold.dat"],foldsort3out,"Table"];
Export[StringJoin[thisfolder,"fold.png"],plotty];
Export[StringJoin[thisfolder,"foldbin.dat"],foldzbin,"Table"];

